<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ART Commodity Management System - Zambia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        body {
            display: flex;
        }

        /* ===== LOGIN PAGE ===== */
        .login-page {
            width: 100%;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 15px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px 30px;
            max-width: 900px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: center;
        }

        .login-image {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .arv-bottle {
            width: 120px;
            height: 160px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .login-form {
            display: flex;
            flex-direction: column;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #1e3c72;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        select:disabled {
            background-color: #f5f5f5;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-button {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(42, 82, 152, 0.4);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #c62828;
            display: none;
            font-size: 13px;
        }

        /* ===== MAIN APP LAYOUT ===== */
        .app-layout {
            display: none;
            width: 100%;
            min-height: 100vh;
            flex-direction: column;
        }

        .top-navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-size: 18px;
            font-weight: 700;
        }

        .navbar-user {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ===== SIDEBAR MENU ===== */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

        .menu-section {
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .menu-section:first-child {
            padding-top: 10px;
        }

        .menu-title {
            padding: 0 20px;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: #333;
            font-size: 13px;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #f5f5f5;
            border-left-color: #2a5298;
        }

        .menu-item.active {
            background: #e3f2fd;
            border-left-color: #2a5298;
            font-weight: 600;
            color: #1e3c72;
        }

        .menu-icon {
            font-size: 16px;
        }

        /* ===== MAIN CONTENT ===== */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: #f5f5f5;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-header h1 {
            color: #1e3c72;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .page-header p {
            color: #666;
            font-size: 14px;
        }

        /* ===== DASHBOARD ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #2a5298;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .window-status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .window-status.open {
            border-left: 5px solid #4caf50;
        }

        .window-status.closed {
            border-left: 5px solid #f44336;
        }

        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-open {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-closed {
            background: #ffebee;
            color: #c62828;
        }

        .low-stock-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .low-stock-item {
            padding: 12px;
            background: #fff3e0;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #f57c00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        /* ===== FORM STYLES ===== */
        .form-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .form-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-number {
            background: #1e3c72;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .section-title {
            color: #1e3c72;
            font-size: 18px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        thead {
            background: #f5f5f5;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 12px;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        input[type="number"], input[type="date"], input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input[type="number"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .calculated-field {
            background: #e3f2fd;
            font-weight: 600;
            color: #1565c0;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
        }

        /* ===== BUTTONS ===== */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2ecc71;
            color: white;
        }

        .btn-primary:hover {
            background: #27ae60;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #3498db;
            color: white;
        }

        .btn-success:hover {
            background: #2980b9;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: none;
            font-size: 13px;
        }

        .alert.show {
            display: block;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #1565c0;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4caf50;
        }

        .alert-warning {
            background: #fff3e0;
            color: #e65100;
            border-color: #f57c00;
        }

        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .login-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 200px;
            }

            .content-area {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
                overflow-x: auto;
                display: flex;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .menu-section {
                display: flex;
                border: none;
                padding: 0;
                white-space: nowrap;
                border-right: 1px solid #f0f0f0;
                padding-right: 15px;
                margin-right: 15px;
            }

            .menu-title {
                display: none;
            }

            .menu-item {
                padding: 12px 15px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }

            .menu-item.active {
                border-left: none;
                border-bottom-color: #2a5298;
            }

            .content-area {
                padding: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .page-header h1 {
                font-size: 22px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
                overflow-x: auto;
            }

            th, td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 14px;
            }

            .top-navbar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .navbar-user {
                width: 100%;
                justify-content: space-between;
            }

            .page-header h1 {
                font-size: 20px;
            }

            button {
                padding: 10px 15px;
                font-size: 12px;
            }
        }

        .report-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .report-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-item:hover {
            background: #f9f9f9;
        }

        .report-item.approved {
            border-left: 4px solid #4caf50;
        }

        .report-item.pending {
            border-left: 4px solid #ff9800;
        }

        .report-item.rejected {
            border-left: 4px solid #f44336;
        }

        .report-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-approved {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-pending {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-rejected {
            background: #ffebee;
            color: #c62828;
        }

        .inbox-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2a5298;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .inbox-item.unread {
            background: #e3f2fd;
            border-left-color: #1976d2;
        }

        .inbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .inbox-title {
            font-weight: 600;
            color: #1e3c72;
            font-size: 13px;
        }

        .inbox-time {
            font-size: 11px;
            color: #999;
        }

        .inbox-message {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-image">
                <div class="arv-bottle">💊</div>
            </div>
            <div class="login-form">
                <div class="login-header">
                    <h1>ART Commodity Management</h1>
                    <p>Antiretroviral Therapy Supply Chain Monitoring System - Zambia Health Ministry</p>
                </div>
                <div id="loginError" class="error-message"></div>
                <form onsubmit="handleLogin(event)">
                    <!-- STEP 1: SELECT ROLE -->
                    <div id="roleStep">
                        <div class="form-group">
                            <label for="userRole">Select Your Role</label>
                            <select id="userRole" onchange="updateLoginForm()" required>
                                <option value="">-- Select Role --</option>
                                <option value="staff">Facility Staff</option>
                                <option value="coordinator">District Coordinator</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                    </div>

                    <!-- STEP 2: FACILITY STAFF FORM -->
                    <div id="staffForm" style="display: none;">
                        <div class="form-group">
                            <label for="province">Province</label>
                            <select id="province" onchange="loadDistricts()" required>
                                <option value="">-- Select Province --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="district">District</label>
                            <select id="district" onchange="loadFacilities()" disabled required>
                                <option value="">-- Select District --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="facility">Facility</label>
                            <select id="facility" disabled required>
                                <option value="">-- Select Facility --</option>
                            </select>
                        </div>
                    </div>

                    <!-- STEP 3: COORDINATOR FORM -->
                    <div id="coordForm" style="display: none;">
                        <div class="form-group">
                            <label for="coordProvince">Province</label>
                            <select id="coordProvince" onchange="loadCoordDistricts()" required>
                                <option value="">-- Select Province --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="coordDistrict">District</label>
                            <select id="coordDistrict" disabled required>
                                <option value="">-- Select District --</option>
                            </select>
                        </div>
                    </div>

                    <!-- CREDENTIALS (ALL ROLES) -->
                    <div id="credentialsStep">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" placeholder="Enter username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" placeholder="Enter password" required>
                        </div>
                    </div>

                    <button type="submit" class="login-button">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="app-layout">
        <div class="top-navbar">
            <div class="navbar-brand">🏥 ART Commodity System</div>
            <div class="navbar-user">
                <div>
                    <div style="font-size: 13px; font-weight: 600;"><span id="userDisplay">User</span></div>
                    <div style="font-size: 11px; opacity: 0.9;"><span id="roleDisplay">Role</span> • <span id="facilityDisplay">Facility</span></div>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div class="main-container">
            <!-- SIDEBAR MENU -->
            <div class="sidebar">
                <div class="menu-section" id="staffMenu" style="display: none;">
                    <div class="menu-title">Facility Staff</div>
                    <div class="menu-item active" onclick="switchPage('dashboard', this)">
                        <span class="menu-icon">📊</span> Dashboard
                    </div>
                    <div class="menu-item" onclick="switchPage('submitReport', this)">
                        <span class="menu-icon">📋</span> Submit Report
                    </div>
                    <div class="menu-item" onclick="switchPage('viewReports', this)">
                        <span class="menu-icon">📑</span> View Reports
                    </div>
                    <div class="menu-item" onclick="switchPage('inbox', this)">
                        <span class="menu-icon">📨</span> Inbox
                    </div>
                    <div class="menu-item" onclick="switchPage('analytics', this)">
                        <span class="menu-icon">📈</span> Analytics
                    </div>
                </div>

                <div class="menu-section" id="coordMenu" style="display: none;">
                    <div class="menu-title">Coordinator</div>
                    <div class="menu-item active" onclick="switchPage('dashboard', this)">
                        <span class="menu-icon">📊</span> Dashboard
                    </div>
                    <div class="menu-item" onclick="switchPage('reviewReports', this)">
                        <span class="menu-icon">✅</span> Review Reports
                    </div>
                    <div class="menu-item" onclick="switchPage('districtReport', this)">
                        <span class="menu-icon">🗺️</span> District Report
                    </div>
                    <div class="menu-item" onclick="switchPage('messaging', this)">
                        <span class="menu-icon">💬</span> Messaging
                    </div>
                    <div class="menu-item" onclick="switchPage('facilityMonitor', this)">
                        <span class="menu-icon">👁️</span> Facility Monitor
                    </div>
                </div>

                <div class="menu-section" id="adminMenu" style="display: none;">
                    <div class="menu-title">Administrator</div>
                    <div class="menu-item active" onclick="switchPage('adminDashboard', this)">
                        <span class="menu-icon">📊</span> Dashboard
                    </div>
                    <div class="menu-item" onclick="switchPage('manageFacilities', this)">
                        <span class="menu-icon">🏥</span> Manage Facilities
                    </div>
                    <div class="menu-item" onclick="switchPage('manageCommodities', this)">
                        <span class="menu-icon">📦</span> Manage Commodities
                    </div>
                    <div class="menu-item" onclick="switchPage('manageUsers', this)">
                        <span class="menu-icon">👥</span> Manage Users
                    </div>
                    <div class="menu-item" onclick="switchPage('windowControl', this)">
                        <span class="menu-icon">⏰</span> Reporting Window
                    </div>
                </div>
            </div>

            <!-- CONTENT AREA -->
            <div class="content-area">
                <!-- STAFF: DASHBOARD -->
                <div id="dashboard" class="page active">
                    <div class="page-header">
                        <h1>Dashboard</h1>
                        <p>Welcome to ART Commodity Management System</p>
                    </div>

                    <div class="window-status" id="windowStatus">
                        <span class="status-indicator status-open">✓ Reporting Window Open</span>
                        <p style="font-size: 13px; color: #666; margin-top: 8px;">Thu-Sat 12:00 PM | Submit reports during this window</p>
                    </div>

                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalReportsCount">0</div>
                            <div class="stat-label">Reports Submitted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lowStockCount">0</div>
                            <div class="stat-label">Low Stock Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingCount">0</div>
                            <div class="stat-label">Pending Review</div>
                        </div>
                    </div>

                    <div class="low-stock-list" id="lowStockContainer"></div>
                </div>

                <!-- STAFF: SUBMIT REPORT -->
                <div id="submitReport" class="page">
                    <div class="page-header">
                        <h1>Submit Weekly Report</h1>
                        <p>Record your facility's commodity stock and movements</p>
                    </div>

                    <div id="reportAlert" class="alert alert-info show">
                        <strong>ℹ️ Information:</strong> Complete all five sections below. Each section will save automatically.
                    </div>

                    <form id="reportForm">
                        <!-- SECTION 1: ARVs -->
                        <div class="form-card" id="section1Card">
                            <div class="form-section-header">
                                <div class="section-number">1</div>
                                <div class="section-title">Antiretroviral Drugs (ARVs)</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Commodity</th>
                                        <th>Opening Balance</th>
                                        <th>Received</th>
                                        <th>Used</th>
                                        <th>Given Out</th>
                                        <th>Closing Balance</th>
                                        <th>Expiry Date</th>
                                    </tr>
                                </thead>
                                <tbody id="arvTableBody"></tbody>
                            </table>
                        </div>

                        <!-- SECTION 2: HIV TEST KITS -->
                        <div class="form-card" id="section2Card">
                            <div class="form-section-header">
                                <div class="section-number">2</div>
                                <div class="section-title">HIV Testing Kits</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Commodity</th>
                                        <th>Opening Balance</th>
                                        <th>Received</th>
                                        <th>Used</th>
                                        <th>Given Out</th>
                                        <th>Closing Balance</th>
                                        <th>Expiry Date</th>
                                    </tr>
                                </thead>
                                <tbody id="hivTableBody"></tbody>
                            </table>
                        </div>

                        <!-- SECTION 3: PAEDIATRIC pALD -->
                        <div class="form-card" id="section3Card">
                            <div class="form-section-header">
                                <div class="section-number">3</div>
                                <div class="section-title">Paediatric Treatment (pALD)</div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Current Paediatric on pALD (from last report)</label>
                                    <input type="number" id="currentPaedOnPaLD" readonly value="0">
                                </div>
                                <div class="input-group">
                                    <label>Paediatric Starting pALD This Week</label>
                                    <input type="number" id="startingPaLD" min="0" value="0" onchange="calculateTotalPaLD()">
                                </div>
                                <div class="input-group">
                                    <label>Stopped/Transitioned From pALD (switched to another drug)</label>
                                    <input type="number" id="stoppedPaLD" min="0" value="0" onchange="calculateTotalPaLD()">
                                </div>
                                <div class="input-group">
                                    <label><strong>Total Paediatric on pALD</strong></label>
                                    <input type="number" id="totalPaLD" readonly class="calculated-field">
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 4: 3HP TB PREVENTIVE -->
                        <div class="form-card" id="section4Card">
                            <div class="form-section-header">
                                <div class="section-number">4</div>
                                <div class="section-title">TB Preventive Therapy (3HP) Monitoring</div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>3HP in Stock (from ARVs closing balance)</label>
                                    <input type="number" id="hpStock" readonly value="0">
                                </div>
                                <div class="input-group">
                                    <label>Current on 3HP (from last report)</label>
                                    <input type="number" id="currentOn3HP" readonly value="0">
                                </div>
                                <div class="input-group">
                                    <label>Initiated on 3HP This Week</label>
                                    <input type="number" id="initiated3HP" min="0" value="0" onchange="calculate3HP()">
                                </div>
                                <div class="input-group">
                                    <label><strong>Total on 3HP This Fiscal Year</strong></label>
                                    <input type="number" id="totalOn3HP" readonly class="calculated-field">
                                </div>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-top: 15px; padding: 12px; background: #fff9c4; border-radius: 6px; border-left: 3px solid #f57c00;">
                                <strong>Note:</strong> 3HP is taken for 1 month only. Clients automatically counted out after 30 days.
                            </p>
                        </div>

                        <!-- SECTION 5: NACS -->
                        <div class="form-card" id="section5Card">
                            <div class="form-section-header">
                                <div class="section-number">5</div>
                                <div class="section-title">Nutrition Assessment & Counselling (NACS)</div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Total Clients Screened This Week</label>
                                    <input type="number" id="clientsScreened" min="0" value="0">
                                </div>
                                <div class="input-group">
                                    <label>Total Underweight (SAM + MAM)</label>
                                    <input type="number" id="underweightTotal" min="0" value="0" onchange="showUnderweightBreakdown()">
                                </div>
                                <div class="input-group" id="samGroup" style="display: none;">
                                    <label>SAM (Severe Acute Malnutrition)</label>
                                    <input type="number" id="samCount" min="0" value="0">
                                </div>
                                <div class="input-group" id="mamGroup" style="display: none;">
                                    <label>MAM (Moderate Acute Malnutrition)</label>
                                    <input type="number" id="mamCount" min="0" value="0">
                                </div>
                                <div class="input-group">
                                    <label>Eligible for HEPS Support</label>
                                    <input type="number" id="eligibleHEPS" min="0" value="0">
                                </div>
                                <div class="input-group">
                                    <label>Total Overweight</label>
                                    <input type="number" id="overweightTotal" min="0" value="0">
                                </div>
                            </div>

                            <div style="margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                                <h3 style="color: #1e3c72; font-size: 15px; margin-bottom: 15px;">HEPS Distribution</h3>
                                <div class="input-row">
                                    <div class="input-group">
                                        <label>Current HEPS in Stock (from last balance)</label>
                                        <input type="number" id="currentHEPSStock" readonly value="0">
                                    </div>
                                    <div class="input-group">
                                        <label>Bags of HEPS Received This Week</label>
                                        <input type="number" id="hepsReceived" min="0" value="0" onchange="calculateTotalHEPS()">
                                    </div>
                                    <div class="input-group">
                                        <label>Bags of HEPS Given to Other Departments</label>
                                        <input type="number" id="hepsGivenOut" min="0" value="0" onchange="calculateTotalHEPS()">
                                    </div>
                                    <div class="input-group">
                                        <label>Clients Due for HEPS Refill</label>
                                        <input type="number" id="hepsRefillDue" min="0" value="0" onchange="calculateTotalHEPS()">
                                    </div>
                                    <div class="input-group">
                                        <label><strong>Total Bags HEPS in Stock</strong></label>
                                        <input type="number" id="totalHEPSStock" readonly class="calculated-field">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button type="submit" class="btn-primary">Submit Report</button>
                            <button type="reset" class="btn-secondary">Clear Form</button>
                        </div>
                    </form>
                </div>

                <!-- STAFF: VIEW REPORTS -->
                <div id="viewReports" class="page">
                    <div class="page-header">
                        <h1>View Reports</h1>
                        <p>Access your submitted reports</p>
                    </div>

                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="switchReportView('weekly')" id="btnWeekly">Weekly</button>
                        <button class="btn-secondary" onclick="switchReportView('monthly')" id="btnMonthly">Monthly</button>
                        <button class="btn-secondary" onclick="switchReportView('quarterly')" id="btnQuarterly">Quarterly</button>
                    </div>

                    <div class="report-list" id="reportsList"></div>
                </div>

                <!-- STAFF: INBOX -->
                <div id="inbox" class="page">
                    <div class="page-header">
                        <h1>Inbox</h1>
                        <p>Messages and feedback from your coordinator</p>
                    </div>
                    <div id="inboxList"></div>
                </div>

                <!-- STAFF: ANALYTICS -->
                <div id="analytics" class="page">
                    <div class="page-header">
                        <h1>Analytics</h1>
                        <p>Your facility's commodity trends and statistics</p>
                    </div>
                    <div class="dashboard-grid" id="analyticsContainer"></div>
                </div>

                <!-- ADMIN DASHBOARD -->
                <div id="adminDashboard" class="page">
                    <div class="page-header">
                        <h1>System Administration</h1>
                        <p>Manage system configuration and settings</p>
                    </div>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalFacilities">15</div>
                            <div class="stat-label">Facilities in Nchelenge</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalUsers">42</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalReportsAdmin">156</div>
                            <div class="stat-label">Reports This Month</div>
                        </div>
                    </div>
                </div>

                <!-- ADMIN: MANAGE FACILITIES -->
                <div id="manageFacilities" class="page">
                    <div class="page-header">
                        <h1>Manage Facilities</h1>
                        <p>Add, edit, or remove facilities in Nchelenge District</p>
                    </div>
                    <div class="form-card">
                        <button class="btn-primary" onclick="showAddFacilityForm()" style="margin-bottom: 20px;">+ Add New Facility</button>
                        <div id="facilitiesList"></div>
                    </div>
                </div>

                <!-- ADMIN: MANAGE COMMODITIES -->
                <div id="manageCommodities" class="page">
                    <div class="page-header">
                        <h1>Manage Commodities</h1>
                        <p>Configure available commodities in the system</p>
                    </div>
                    <div class="form-card">
                        <button class="btn-primary" onclick="showAddCommodityForm()" style="margin-bottom: 20px;">+ Add New Commodity</button>
                        <div id="commoditiesList"></div>
                    </div>
                </div>

                <!-- ADMIN: MANAGE USERS -->
                <div id="manageUsers" class="page">
                    <div class="page-header">
                        <h1>Manage Users</h1>
                        <p>Create and manage system user accounts</p>
                    </div>
                    <div class="form-card">
                        <button class="btn-primary" onclick="showAddUserForm()" style="margin-bottom: 20px;">+ Create New User</button>
                        <div id="usersList"></div>
                    </div>
                </div>

                <!-- ADMIN: REPORTING WINDOW CONTROL -->
                <div id="windowControl" class="page">
                    <div class="page-header">
                        <h1>Reporting Window Control</h1>
                        <p>Manage reporting submission periods</p>
                    </div>
                    <div class="form-card">
                        <div class="input-row">
                            <div class="input-group">
                                <label>Current Window Status</label>
                                <input type="text" value="Thu-Sat 12:00 PM" readonly>
                            </div>
                            <div class="input-group">
                                <label>Action</label>
                                <select>
                                    <option>-- Select Action --</option>
                                    <option>Force Open Window</option>
                                    <option>Force Close Window</option>
                                    <option>Reset to Normal</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="alert('Window updated')">Apply Changes</button>
                    </div>
                </div>

                <!-- COORDINATOR: REVIEW REPORTS -->
                <div id="reviewReports" class="page">
                    <div class="page-header">
                        <h1>Review Pending Reports</h1>
                        <p>Approve or reject facility reports submitted for review</p>
                    </div>
                    <div id="pendingReportsList" class="report-list"></div>
                </div>

                <!-- COORDINATOR: DISTRICT REPORT -->
                <div id="districtReport" class="page">
                    <div class="page-header">
                        <h1>District Report</h1>
                        <p>Aggregate data from all facilities in Nchelenge</p>
                    </div>
                    <div class="form-card">
                        <div class="input-row">
                            <div class="input-group">
                                <label>Select Report Period</label>
                                <select>
                                    <option>Weekly</option>
                                    <option>Monthly</option>
                                    <option>Quarterly</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Select Facilities</label>
                                <select multiple>
                                    <option selected>All Facilities</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="generateDistrictReport()">Generate Report</button>
                    </div>
                </div>

                <!-- COORDINATOR: MESSAGING -->
                <div id="messaging" class="page">
                    <div class="page-header">
                        <h1>Send Feedback</h1>
                        <p>Communicate with facility staff about their reports</p>
                    </div>
                    <div class="form-card">
                        <div class="input-row">
                            <div class="input-group">
                                <label>Select Facility</label>
                                <select id="messageToFacility"></select>
                            </div>
                            <div class="input-group">
                                <label>Message Type</label>
                                <select>
                                    <option>Feedback on Report</option>
                                    <option>Alert / Notification</option>
                                    <option>Request for Clarification</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Message</label>
                            <textarea placeholder="Type your message..." style="min-height: 120px;"></textarea>
                        </div>
                        <button class="btn-primary" onclick="sendMessage()">Send Message</button>
                    </div>
                </div>

                <!-- COORDINATOR: FACILITY MONITOR -->
                <div id="facilityMonitor" class="page">
                    <div class="page-header">
                        <h1>Facility Performance Monitor</h1>
                        <p>View stock levels and reporting status across facilities</p>
                    </div>
                    <div id="facilityMonitorTable"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA CONFIGURATION =====
        const PROVINCES = {
            'Lusaka': ['Lusaka District'],
            'Copperbelt': ['Kitwe', 'Ndola', 'Chililabombwe', 'Nkana'],
            'Western': ['Kasempa', 'Kaoma', 'Zambezi'],
            'Northern': ['Kasama', 'Mbala', 'Isoka'],
            'Luapula': ['Mansa', 'Kawambwa', 'Nchelenge'],
            'Central': ['Kabwe', 'Mkushi', 'Mpongwe'],
            'Southern': ['Livingstone', 'Kazungula', 'Siavonga'],
            'Eastern': ['Chipata', 'Katete', 'Petauke'],
            'Muchinga': ['Chinsali', 'Ishimu', 'Nakonde'],
            'North Western': ['Solwezi', 'Kalumbila', 'Kasempa']
        };

        const NCHELENGE_FACILITIES = [
            { id: 'kabuta-rhc', name: 'Kabuta Rural Health Centre' },
            { id: 'kefulw-rhp', name: 'Kefulw Rural Health Post' },
            { id: 'shimpundu-rhp', name: 'Shimpundu Rural Health Post' },
            { id: 'kafutuma-rhp', name: 'Kafutuma Rural Health Post' },
            { id: 'ntoto-rhp', name: 'Ntoto Rural Health Post' },
            { id: 'kashikishi-hc', name: 'Kashikishi Affiliated Health Centre' },
            { id: 'stpauls-hospital', name: 'St. Pauls Mission Hospital' },
            { id: 'nchelenge-rhc', name: 'Nchelenge Rural Health Centre' },
            { id: 'kambwali-rhc', name: 'Kambwali Rural Health Centre' },
            { id: 'kanyembo-rhc', name: 'Kanyembo Rural Health Centre' },
            { id: 'tokatoka-rhp', name: 'Tokatoka Rural Health Post' },
            { id: 'kabalenge-rhc', name: 'Kabalenge Rural Health Centre' },
            { id: 'kasumpa-rhp', name: 'Kasumpa Rural Health Post' },
            { id: 'mantapala-rhp', name: 'Mantapala Rural Health Post' },
            { id: 'mulwe-rhp', name: 'Mulwe Rural Health Post' }
        ];

        const ARVs = [
            'TLD 30 (Tenofovir/Lamivudine/Dolutegravir)',
            'TLD 90 (Tenofovir/Lamivudine/Dolutegravir)',
            'TLD 180 (Tenofovir/Lamivudine/Dolutegravir)',
            'TafED 30 (Tenofovir Alafenamide/Efavirence/Dolutegravir)',
            'TafED 90 (Tenofovir Alafenamide/Efavirence/Dolutegravir)',
            'TafED 180 (Tenofovir Alafenamide/Efavirence/Dolutegravir)',
            'Dolutegravir 50mg 30s',
            'Dolutegravir 10mg 90s',
            '3HP (Isoniazid/Rifapentine)',
            'Isoniazid 300mg',
            'TDF/FTC (Tenofovir/Emtricitabine - PrEP)',
            'ABC/3TC (Abacavir/Lamivudine - Paediatric)',
            'ABC/3TC (Abacavir/Lamivudine - Adult)',
            'pALD (Abacavir/Lamivudine/Dolutegravir)',
            'Nevirapine Syrup (NVP)',
            'Benzathine Penicillin Injection',
            'Lignocaine'
        ];

        const HIV_KITS = [
            'Abbott Determine',
            'Abbott Bioline',
            'HIV/Syphilis Duo (Combo)',
            'HIV Self Test',
            'EDTA Bottles',
            'Dry Blood Spot Cards (DBS)'
        ];

        // Demo Users
        const DEMO_USERS = {
            'staff_kabuta': { password: 'Staff@123', role: 'staff', facility: 'kabuta-rhc' },
            'coord_nchelenge': { password: 'Coord@123', role: 'coordinator', district: 'Nchelenge' },
            'admin_system': { password: 'Admin@123', role: 'admin' }
        };

        let currentUser = null;
        let currentReportView = 'weekly';

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            loadProvinces();
            loadCoordProvinces();
            checkUserSession();
        });

        // ===== LOGIN FORM MANAGEMENT =====
        function updateLoginForm() {
            const role = document.getElementById('userRole').value;
            const staffForm = document.getElementById('staffForm');
            const coordForm = document.getElementById('coordForm');

            staffForm.style.display = 'none';
            coordForm.style.display = 'none';

            // Clear previous selections
            document.getElementById('province').value = '';
            document.getElementById('district').value = '';
            document.getElementById('facility').value = '';
            document.getElementById('coordProvince').value = '';
            document.getElementById('coordDistrict').value = '';

            if (role === 'staff') {
                staffForm.style.display = 'block';
            } else if (role === 'coordinator') {
                coordForm.style.display = 'block';
            }
        }

        function loadProvinces() {
            const select = document.getElementById('province');
            Object.keys(PROVINCES).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                select.appendChild(option);
            });
        }

        function loadDistricts() {
            const province = document.getElementById('province').value;
            const districtSelect = document.getElementById('district');
            districtSelect.innerHTML = '<option value="">-- Select District --</option>';
            districtSelect.disabled = !province;

            if (province && PROVINCES[province]) {
                PROVINCES[province].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        function loadFacilities() {
            const district = document.getElementById('district').value;
            const facilitySelect = document.getElementById('facility');
            facilitySelect.innerHTML = '<option value="">-- Select Facility --</option>';
            facilitySelect.disabled = !district;

            if (district === 'Nchelenge') {
                NCHELENGE_FACILITIES.forEach(facility => {
                    const option = document.createElement('option');
                    option.value = facility.id;
                    option.textContent = facility.name;
                    facilitySelect.appendChild(option);
                });
            }
        }

        function loadCoordProvinces() {
            const select = document.getElementById('coordProvince');
            Object.keys(PROVINCES).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                select.appendChild(option);
            });
        }

        function loadCoordDistricts() {
            const province = document.getElementById('coordProvince').value;
            const districtSelect = document.getElementById('coordDistrict');
            districtSelect.innerHTML = '<option value="">-- Select District --</option>';
            districtSelect.disabled = !province;

            if (province && PROVINCES[province]) {
                PROVINCES[province].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        // ===== AUTHENTICATION =====
        function handleLogin(event) {
            event.preventDefault();

            const role = document.getElementById('userRole').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (!role) {
                showLoginError('Please select a role', errorDiv);
                return;
            }

            const user = DEMO_USERS[username];

            if (!user || user.password !== password) {
                showLoginError('Invalid username or password', errorDiv);
                return;
            }

            if (user.role !== role) {
                showLoginError('Username does not match selected role', errorDiv);
                return;
            }

            let facilityName = '';
            let district = '';

            if (user.role === 'staff') {
                const facilityId = document.getElementById('facility').value;
                if (!facilityId) {
                    showLoginError('Please select a facility', errorDiv);
                    return;
                }
                const facility = NCHELENGE_FACILITIES.find(f => f.id === facilityId);
                facilityName = facility ? facility.name : 'Unknown';
                district = 'Nchelenge';

                currentUser = {
                    username: username,
                    role: user.role,
                    facility: facilityId,
                    facilityName: facilityName,
                    district: district,
                    isFirstTimeReport: !getLastReport(facilityId)
                };
            } else if (user.role === 'coordinator') {
                const coordDistrict = document.getElementById('coordDistrict').value;
                if (!coordDistrict) {
                    showLoginError('Please select a district', errorDiv);
                    return;
                }

                currentUser = {
                    username: username,
                    role: user.role,
                    district: coordDistrict,
                    facilityName: coordDistrict + ' District'
                };
            } else if (user.role === 'admin') {
                currentUser = {
                    username: username,
                    role: user.role,
                    facilityName: 'System Administration'
                };
            }

            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
            errorDiv.style.display = 'none';
        }

        function showLoginError(msg, elem) {
            elem.textContent = msg;
            elem.style.display = 'block';
            setTimeout(() => { elem.style.display = 'none'; }, 5000);
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        function checkUserSession() {
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                showApp();
            }
        }

        // ===== APP DISPLAY =====
        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';

            // Set user display
            document.getElementById('userDisplay').textContent = currentUser.username;
            document.getElementById('roleDisplay').textContent = currentUser.role === 'staff' ? 'Facility Staff' : currentUser.role === 'coordinator' ? 'Coordinator' : 'Administrator';
            document.getElementById('facilityDisplay').textContent = currentUser.facilityName || 'System';

            // Show appropriate menu
            if (currentUser.role === 'staff') {
                document.getElementById('staffMenu').style.display = 'block';
                initializeReportForm();
            } else if (currentUser.role === 'coordinator') {
                document.getElementById('coordMenu').style.display = 'block';
                loadFacilitiesForCoordinator();
            } else if (currentUser.role === 'admin') {
                document.getElementById('adminMenu').style.display = 'block';
            }

            switchPage('dashboard', document.querySelector('.menu-item'));
            checkReportingWindow();
            updateDashboard();
        }

        function switchPage(pageId, element) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if (element) element.classList.add('active');

            // Load page-specific content
            if (pageId === 'viewReports') {
                displayReports();
            } else if (pageId === 'inbox') {
                displayInbox();
            } else if (pageId === 'analytics') {
                displayAnalytics();
            } else if (pageId === 'reviewReports') {
                displayPendingReports();
            } else if (pageId === 'facilityMonitor') {
                displayFacilityMonitor();
            }
        }

        // ===== REPORTING WINDOW CHECK =====
        function checkReportingWindow() {
            const now = new Date();
            const day = now.getDay();
            const hours = now.getHours();
            const isOpen = (day === 4 || day === 5 || (day === 6 && hours < 12)); // Thu, Fri, Sat before noon

            const windowDiv = document.getElementById('windowStatus');
            if (windowDiv) {
                if (isOpen) {
                    windowDiv.className = 'window-status open';
                    windowDiv.innerHTML = '<span class="status-indicator status-open">✓ Reporting Window Open</span><p style="font-size: 13px; color: #666; margin-top: 8px;">Thu-Sat 12:00 PM | Submit reports during this window</p>';
                } else {
                    windowDiv.className = 'window-status closed';
                    windowDiv.innerHTML = '<span class="status-indicator status-closed">✗ Reporting Window Closed</span><p style="font-size: 13px; color: #666; margin-top: 8px;">Reports can only be submitted Thu-Sat before 12:00 PM</p>';
                }
            }
        }

        // ===== DASHBOARD UPDATE =====
        function updateDashboard() {
            if (!currentUser.facility) return;
            
            const reports = getReports(currentUser.facility);
            document.getElementById('totalReportsCount').textContent = reports.length;

            const lastReport = getLastReport(currentUser.facility);
            let lowStockCount = 0;
            let lowStockHTML = '<h3 style="color: #1e3c72; margin-bottom: 15px;">Low Stock Items</h3>';

            if (lastReport) {
                lastReport.commodities.arv.forEach(arv => {
                    if (arv.closingBalance < 100) {
                        lowStockCount++;
                        lowStockHTML += `<div class="low-stock-item">
                            <div>${arv.name}</div>
                            <div><strong>${arv.closingBalance}</strong> units</div>
                        </div>`;
                    }
                });

                lastReport.commodities.hiv.forEach(hiv => {
                    if (hiv.closingBalance < 50) {
                        lowStockCount++;
                        lowStockHTML += `<div class="low-stock-item">
                            <div>${hiv.name}</div>
                            <div><strong>${hiv.closingBalance}</strong> units</div>
                        </div>`;
                    }
                });
            }

            if (lowStockCount === 0) {
                lowStockHTML += '<p style="text-align: center; color: #666; padding: 20px;">No low stock items</p>';
            }

            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('lowStockContainer').innerHTML = lowStockHTML;

            // Pending reviews
            document.getElementById('pendingCount').textContent = reports.filter(r => r.status === 'pending').length;
        }

        // ===== REPORT FORM =====
        function initializeReportForm() {
            const isFirstTime = currentUser.isFirstTimeReport;

            // ARVs
            const arvBody = document.getElementById('arvTableBody');
            arvBody.innerHTML = ARVs.map((arv, i) => `
                <tr data-commodity="${arv}">
                    <td>${arv}</td>
                    <td><input type="number" class="opening" min="0" value="0" ${isFirstTime ? '' : 'readonly'}></td>
                    <td><input type="number" class="received" min="0" value="0" onchange="calculateRow(this)"></td>
                    <td><input type="number" class="used" min="0" value="0" onchange="calculateRow(this)"></td>
                    <td><input type="number" class="givenOut" min="0" value="0" onchange="calculateRow(this)"></td>
                    <td class="calculated"><span class="closing">0</span></td>
                    <td><input type="date" class="expiry"></td>
                </tr>
            `).join('');

            // HIV Kits
            const hivBody = document.getElementById('hivTableBody');
            hivBody.innerHTML = HIV_KITS.map(kit => `
                <tr data-commodity="${kit}">
                    <td>${kit}</td>
                    <td><input type="number" class="opening" min="0" value="0" ${isFirstTime ? '' : 'readonly'}></td>
                    <td><input type="number" class="received" min="0" value="0" onchange="calculateRow(this)"></td>
                    <td><input type="number" class="used" min="0" value="0" onchange="calculateRow(this)"></td>
                    <td><input type="number" class="givenOut" min="0" value="0" onchange="calculateRow(this)"></td>
                    <td class="calculated"><span class="closing">0</span></td>
                    <td><input type="date" class="expiry"></td>
                </tr>
            `).join('');

            // Load previous report data for subsequent reports
            if (!isFirstTime) {
                loadPreviousReportData();
            }

            // Bind form submit
            document.getElementById('reportForm').addEventListener('submit', handleSubmitReport);
        }

        function loadPreviousReportData() {
            const lastReport = getLastReport(currentUser.facility);
            if (!lastReport) return;

            // ARVs opening balance
            lastReport.commodities.arv.forEach(arv => {
                const row = document.querySelector(`#arvTableBody tr[data-commodity="${arv.name}"]`);
                if (row) row.querySelector('.opening').value = arv.closingBalance;
            });

            // HIV kits opening balance
            lastReport.commodities.hiv.forEach(hiv => {
                const row = document.querySelector(`#hivTableBody tr[data-commodity="${hiv.name}"]`);
                if (row) row.querySelector('.opening').value = hiv.closingBalance;
            });

            // Section 3-5 data
            document.getElementById('currentPaedOnPaLD').value = lastReport.paediatric.totalOnPaLD;
            document.getElementById('currentOn3HP').value = lastReport.hp3.totalOn3HP;
            document.getElementById('currentHEPSStock').value = lastReport.nacs.totalHEPS;
        }

        function calculateRow(input) {
            const row = input.closest('tr');
            const opening = parseFloat(row.querySelector('.opening').value) || 0;
            const received = parseFloat(row.querySelector('.received').value) || 0;
            const used = parseFloat(row.querySelector('.used').value) || 0;
            const givenOut = parseFloat(row.querySelector('.givenOut').value) || 0;
            const closing = opening + received - used - givenOut;

            // Validation
            if (used + givenOut > opening + received) {
                row.querySelector('.closing').textContent = '❌ Error';
                row.querySelector('.closing').style.color = '#f44336';
                return false;
            }

            row.querySelector('.closing').textContent = Math.max(0, closing);
            row.querySelector('.closing').style.color = '#1565c0';
            return true;
        }

        function calculateTotalPaLD() {
            const current = parseFloat(document.getElementById('currentPaedOnPaLD').value) || 0;
            const starting = parseFloat(document.getElementById('startingPaLD').value) || 0;
            const stopped = parseFloat(document.getElementById('stoppedPaLD').value) || 0;
            const total = current + starting - stopped;
            document.getElementById('totalPaLD').value = Math.max(0, total);
        }

        function calculate3HP() {
            const hp3Row = document.querySelector('#arvTableBody tr[data-commodity="3HP (Isoniazid/Rifapentine)"]');
            if (hp3Row) {
                document.getElementById('hpStock').value = hp3Row.querySelector('.closing').textContent;
            }

            const current = parseFloat(document.getElementById('currentOn3HP').value) || 0;
            const initiated = parseFloat(document.getElementById('initiated3HP').value) || 0;
            const total = current + initiated;
            document.getElementById('totalOn3HP').value = total;
        }

        function showUnderweightBreakdown() {
            const underweightTotal = parseFloat(document.getElementById('underweightTotal').value) || 0;
            if (underweightTotal > 0) {
                document.getElementById('samGroup').style.display = 'flex';
                document.getElementById('mamGroup').style.display = 'flex';
            } else {
                document.getElementById('samGroup').style.display = 'none';
                document.getElementById('mamGroup').style.display = 'none';
                document.getElementById('samCount').value = 0;
                document.getElementById('mamCount').value = 0;
            }
        }

        function calculateTotalHEPS() {
            const current = parseFloat(document.getElementById('currentHEPSStock').value) || 0;
            const received = parseFloat(document.getElementById('hepsReceived').value) || 0;
            const givenOut = parseFloat(document.getElementById('hepsGivenOut').value) || 0;
            const refillDue = parseFloat(document.getElementById('hepsRefillDue').value) || 0;
            
            // CORRECTED FORMULA: current + received - given out - refill due
            const total = current + received - givenOut - refillDue;
            document.getElementById('totalHEPSStock').value = Math.max(0, total);
        }

        // ===== REPORT SUBMISSION =====
        function handleSubmitReport(event) {
            event.preventDefault();

            // Validate all rows
            let isValid = true;
            document.querySelectorAll('#arvTableBody tr, #hivTableBody tr').forEach(row => {
                if (!calculateRow(row.querySelector('.received'))) {
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('Please fix validation errors before submitting');
                return;
            }

            const report = {
                id: Date.now(),
                facility: currentUser.facility,
                facilityName: currentUser.facilityName,
                date: new Date().toISOString().split('T')[0],
                submittedAt: new Date(),
                status: 'pending',
                timeIndicator: getTimeIndicator(),
                commodities: {
                    arv: [],
                    hiv: []
                },
                paediatric: {
                    currentOnPaLD: parseFloat(document.getElementById('currentPaedOnPaLD').value),
                    startingPaLD: parseFloat(document.getElementById('startingPaLD').value),
                    stoppedPaLD: parseFloat(document.getElementById('stoppedPaLD').value),
                    totalOnPaLD: parseFloat(document.getElementById('totalPaLD').value)
                },
                hp3: {
                    stock: parseFloat(document.getElementById('hpStock').value),
                    currentOn3HP: parseFloat(document.getElementById('currentOn3HP').value),
                    initiated: parseFloat(document.getElementById('initiated3HP').value),
                    totalOn3HP: parseFloat(document.getElementById('totalOn3HP').value)
                },
                nacs: {
                    clientsScreened: parseFloat(document.getElementById('clientsScreened').value),
                    underweight: parseFloat(document.getElementById('underweightTotal').value),
                    sam: parseFloat(document.getElementById('samCount').value),
                    mam: parseFloat(document.getElementById('mamCount').value),
                    eligibleHEPS: parseFloat(document.getElementById('eligibleHEPS').value),
                    overweight: parseFloat(document.getElementById('overweightTotal').value),
                    hepsStock: parseFloat(document.getElementById('currentHEPSStock').value),
                    hepsReceived: parseFloat(document.getElementById('hepsReceived').value),
                    hepsGivenOut: parseFloat(document.getElementById('hepsGivenOut').value),
                    hepsRefillDue: parseFloat(document.getElementById('hepsRefillDue').value),
                    totalHEPS: parseFloat(document.getElementById('totalHEPSStock').value)
                }
            };

            // Collect ARVs data
            document.querySelectorAll('#arvTableBody tr').forEach(row => {
                report.commodities.arv.push({
                    name: row.cells[0].textContent,
                    opening: parseFloat(row.querySelector('.opening').value),
                    received: parseFloat(row.querySelector('.received').value),
                    used: parseFloat(row.querySelector('.used').value),
                    givenOut: parseFloat(row.querySelector('.givenOut').value),
                    closingBalance: parseFloat(row.querySelector('.closing').textContent),
                    expiry: row.querySelector('.expiry').value
                });
            });

            // Collect HIV data
            document.querySelectorAll('#hivTableBody tr').forEach(row => {
                report.commodities.hiv.push({
                    name: row.cells[0].textContent,
                    opening: parseFloat(row.querySelector('.opening').value),
                    received: parseFloat(row.querySelector('.received').value),
                    used: parseFloat(row.querySelector('.used').value),
                    givenOut: parseFloat(row.querySelector('.givenOut').value),
                    closingBalance: parseFloat(row.querySelector('.closing').textContent),
                    expiry: row.querySelector('.expiry').value
                });
            });

            saveReport(report);
            alert('✓ Report submitted successfully and sent for review');
            document.getElementById('reportForm').reset();
            updateDashboard();
            switchPage('dashboard', document.querySelector('.menu-item'));
        }

        function getTimeIndicator() {
            const now = new Date();
            const day = now.getDay();
            if (day === 4) return 'excellent'; // Thursday
            if (day === 5) return 'good'; // Friday
            return 'late'; // Saturday
        }

        // ===== DATA STORAGE =====
        function saveReport(report) {
            let reports = JSON.parse(localStorage.getItem('reports')) || [];
            reports.push(report);
            localStorage.setItem('reports', JSON.stringify(reports));
        }

        function getReports(facilityId) {
            let reports = JSON.parse(localStorage.getItem('reports')) || [];
            return reports.filter(r => r.facility === facilityId).sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
        }

        function getLastReport(facilityId) {
            const reports = getReports(facilityId);
            return reports.length > 0 ? reports[0] : null;
        }

        // ===== DISPLAY FUNCTIONS =====
        function displayReports() {
            const reports = getReports(currentUser.facility);
            const container = document.getElementById('reportsList');

            if (reports.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No reports submitted yet</p>';
                return;
            }

            container.innerHTML = reports.map(r => `
                <div class="report-item ${r.status}">
                    <div>
                        <strong>Report - ${r.date}</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Submitted: ${new Date(r.submittedAt).toLocaleString()}</p>
                    </div>
                    <span class="report-status-badge badge-${r.status}">
                        ${r.status === 'approved' ? '✓ Approved' : r.status === 'pending' ? '⏳ Pending' : '✗ Rejected'}
                    </span>
                </div>
            `).join('');
        }

        function switchReportView(view) {
            currentReportView = view;
            document.getElementById('btnWeekly').className = view === 'weekly' ? 'btn-primary' : 'btn-secondary';
            document.getElementById('btnMonthly').className = view === 'monthly' ? 'btn-primary' : 'btn-secondary';
            document.getElementById('btnQuarterly').className = view === 'quarterly' ? 'btn-primary' : 'btn-secondary';
            displayReports();
        }

        function displayInbox() {
            const container = document.getElementById('inboxList');
            const messages = [
                { title: 'Report Approved', message: 'Your report from 2025-01-10 has been approved ✓', read: true },
                { title: 'Request for Clarification', message: 'Please verify the HEPS distribution numbers in your latest report', read: false }
            ];

            container.innerHTML = messages.map(m => `
                <div class="inbox-item ${!m.read ? 'unread' : ''}">
                    <div class="inbox-header">
                        <div class="inbox-title">${m.title}</div>
                        <div class="inbox-time">${new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="inbox-message">${m.message}</div>
                </div>
            `).join('');
        }

        function displayAnalytics() {
            const reports = getReports(currentUser.facility);
            const container = document.getElementById('analyticsContainer');

            if (reports.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No data available</p>';
                return;
            }

            const lastReport = reports[0];
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${reports.length}</div>
                    <div class="stat-label">Total Reports Submitted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${lastReport.paediatric.totalOnPaLD}</div>
                    <div class="stat-label">Paediatric on pALD</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${lastReport.hp3.totalOn3HP}</div>
                    <div class="stat-label">Patients on 3HP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${lastReport.nacs.totalHEPS}</div>
                    <div class="stat-label">HEPS Bags in Stock</div>
                </div>
            `;
        }

        function displayPendingReports() {
            const container = document.getElementById('pendingReportsList');
            let allReports = JSON.parse(localStorage.getItem('reports')) || [];
            const pending = allReports.filter(r => r.status === 'pending');

            if (pending.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No pending reports</p>';
                return;
            }

            container.innerHTML = pending.map(r => `
                <div class="report-item pending">
                    <div>
                        <strong>${r.facilityName}</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Date: ${r.date}</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-success" onclick="approveReport(${r.id})">Approve</button>
                        <button class="btn-danger" onclick="rejectReport(${r.id})">Reject</button>
                    </div>
                </div>
            `).join('');
        }

        function approveReport(reportId) {
            let reports = JSON.parse(localStorage.getItem('reports')) || [];
            const report = reports.find(r => r.id === reportId);
            if (report) {
                report.status = 'approved';
                localStorage.setItem('reports', JSON.stringify(reports));
                displayPendingReports();
                alert('✓ Report approved');
            }
        }

        function rejectReport(reportId) {
            const reason = prompt('Enter reason for rejection:');
            if (reason) {
                let reports = JSON.parse(localStorage.getItem('reports')) || [];
                const report = reports.find(r => r.id === reportId);
                if (report) {
                    report.status = 'rejected';
                    report.rejectionReason = reason;
                    localStorage.setItem('reports', JSON.stringify(reports));
                    displayPendingReports();
                    alert('✓ Report rejected');
                }
            }
        }

        function generateDistrictReport() {
            alert('District report generated successfully');
        }

        function sendMessage() {
            alert('Message sent to facility');
        }

        function displayFacilityMonitor() {
            const container = document.getElementById('facilityMonitorTable');
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Facility monitoring dashboard</p>';
        }

        function loadFacilitiesForCoordinator() {
            const select = document.getElementById('messageToFacility');
            NCHELENGE_FACILITIES.forEach(facility => {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                select.appendChild(option);
            });
        }

        function showAddFacilityForm() {
            alert('Add facility form');
        }

        function showAddCommodityForm() {
            alert('Add commodity form');
        }

        function showAddUserForm() {
            alert('Add user form');
        }
    </script>
</body>
</html>
